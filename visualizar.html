<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Visualiza√ß√£o de Registros e Gr√°fico - Di√°rio APN</title>
        <link rel="icon" href="logo.png" type="image/png" />
        <link rel="stylesheet" href="style.css" />
    </head>
    <body>
        <!-- Cookie Consent Banner -->
        <div id="cookieBanner" class="cookie-banner" style="display: none">
            <div class="cookie-content">
                <div class="cookie-text">
                    <h3>üç™ Pol√≠tica de Privacidade e Cookies</h3>
                    <p>
                        Este site utiliza cookies e armazenamento local para
                        funcionamento adequado.
                        <strong
                            >N√£o armazenamos nenhuma informa√ß√£o online</strong
                        >
                        - todos os dados ficam salvos apenas no seu dispositivo
                        (localStorage). O √∫nico v√≠nculo online √© para envio de
                        feedback por email quando solicitado.
                    </p>
                    <p>
                        <strong>Uso Profissional:</strong> Este sistema √©
                        destinado exclusivamente para uso profissional e
                        corporativo. Todos os dados s√£o mantidos localmente em
                        seu dispositivo para m√°xima seguran√ßa e privacidade.
                    </p>
                </div>
                <div class="cookie-actions">
                    <button id="acceptCookies" class="btn-primary">
                        ‚úÖ Aceitar e Continuar
                    </button>
                    <button id="learnMore" class="btn-secondary">
                        üìñ Saber Mais
                    </button>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="header">
                <div class="header-top">
                    <div class="header-left">
                        <h1>üëÅÔ∏è Visualiza√ß√£o de Registros e Gr√°fico</h1>
                        <p>
                            Veja os registros salvos e estat√≠sticas sem
                            necessidade de preencher contrato.
                        </p>
                    </div>
                    <button
                        id="btnFeedback"
                        class="btn-feedback"
                        title="Enviar Feedback"
                    >
                        üí¨ Feedback
                    </button>
                </div>
            </div>
            <div class="content">
                <div class="stats-section">
                    <h2>üìä Estat√≠sticas</h2>
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                    <button
                        id="exportChartBtn"
                        class="btn-secondary"
                        style="margin-top: 18px"
                    >
                        ‚¨áÔ∏è Exportar Gr√°fico para CSV
                    </button>
                </div>
                <div class="records-section">
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 20px;
                        "
                    >
                        <h2>Registros Salvos</h2>
                        <div>
                            <button id="exportBtn" class="btn-secondary">
                                üìÅ Exportar para TXT
                            </button>
                            <button
                                id="exportCsvBtn"
                                class="btn-secondary"
                                style="margin-left: 10px"
                            >
                                üìä Exportar para CSV
                            </button>
                            <button
                                id="exportJsonBtn"
                                class="btn-secondary"
                                style="margin-left: 10px"
                            >
                                üîÑ Exportar para JSON
                            </button>
                            <button
                                id="clearBtn"
                                class="btn-secondary"
                                style="
                                    background: linear-gradient(
                                        135deg,
                                        #f56565 0%,
                                        #ed8936 100%
                                    );
                                    margin-left: 10px;
                                "
                            >
                                üóëÔ∏è Limpar Registros
                            </button>
                            <button
                                id="btnVoltar"
                                class="btn-secondary"
                                style="margin-left: 10px"
                            >
                                ‚¨ÖÔ∏è Voltar para Registro
                            </button>
                            <button
                                id="btnImportar"
                                class="btn-secondary"
                                style="margin-left: 10px"
                            >
                                üì• Importar Registros
                            </button>
                        </div>
                    </div>
                    <div id="recordsList"></div>
                </div>
            </div>
            <div class="footer">
                <p>Desenvolvido por <strong>KIM Info TEC</strong></p>
                <p>
                    <a
                        href="https://github.com/kiminfodeveloper/diarioAPN"
                        target="_blank"
                        rel="noopener noreferrer"
                    >
                        üìÑ Documenta√ß√£o no GitHub
                    </a>
                </p>
            </div>
        </div>

        <!-- Modal para Edi√ß√£o de Registro -->
        <div id="modalEditar" class="modal-overlay" style="display: none">
            <div class="modal-content modal-large">
                <h2>‚úèÔ∏è Editar Registro</h2>
                <form id="formEditar">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="editContrato"
                                >N¬∫ Contrato ou CNPJ da Empresa *</label
                            >
                            <input
                                type="text"
                                id="editContrato"
                                name="contrato"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="editInterlocutor"
                                >Nome do Interlocutor *</label
                            >
                            <input
                                type="text"
                                id="editInterlocutor"
                                name="interlocutor"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="editProtocolo">Protocolo *</label>
                            <input
                                type="text"
                                id="editProtocolo"
                                name="protocolo"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="editDataLigacao"
                                >Data da Liga√ß√£o *</label
                            >
                            <input
                                type="date"
                                id="editDataLigacao"
                                name="dataLigacao"
                                required
                            />
                        </div>
                        <div class="form-group full-width">
                            <label for="editMotivo">Motivo do Contato *</label>
                            <textarea
                                id="editMotivo"
                                name="motivo"
                                required
                                placeholder="Descreva o motivo do contato..."
                            ></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label>Resolu√ß√£o *</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input
                                        type="radio"
                                        id="editResolvido"
                                        name="resolucao"
                                        value="Resolvido"
                                        required
                                    />
                                    <label for="editResolvido">Resolvido</label>
                                </div>
                                <div class="radio-option">
                                    <input
                                        type="radio"
                                        id="editBko"
                                        name="resolucao"
                                        value="BKO"
                                        required
                                    />
                                    <label for="editBko">BKO</label>
                                </div>
                                <div class="radio-option">
                                    <input
                                        type="radio"
                                        id="editSupervisao"
                                        name="resolucao"
                                        value="Supervis√£o"
                                        required
                                    />
                                    <label for="editSupervisao"
                                        >Supervis√£o</label
                                    >
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-buttons">
                        <button type="submit" class="btn-primary">
                            üíæ Salvar Altera√ß√µes
                        </button>
                        <button
                            type="button"
                            id="btnCancelarEdicao"
                            class="btn-secondary"
                        >
                            ‚ùå Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal de Feedback -->
        <div id="feedbackModal" class="modal-overlay" style="display: none">
            <div class="modal-content feedback-modal">
                <div class="feedback-header">
                    <h2>üí¨ Enviar Feedback</h2>
                    <p>
                        Ajude-nos a melhorar o sistema! Reporte bugs ou envie
                        sugest√µes.
                    </p>
                </div>
                <form id="feedbackForm" class="feedback-form">
                    <div class="form-group">
                        <label for="feedbackType">üìã Tipo de Feedback:</label>
                        <select id="feedbackType" name="feedbackType" required>
                            <option value="">Selecione o tipo...</option>
                            <option value="bug">üêõ Reportar Bug</option>
                            <option value="suggestion">
                                üí° Sugest√£o de Melhoria
                            </option>
                            <option value="feature">
                                ‚ú® Solicitar Nova Funcionalidade
                            </option>
                            <option value="other">üìù Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="feedbackName">üë§ Seu Nome:</label>
                        <input
                            type="text"
                            id="feedbackName"
                            name="feedbackName"
                            placeholder="Digite seu nome (opcional)"
                        />
                    </div>
                    <div class="form-group">
                        <label for="feedbackEmail">üìß E-mail:</label>
                        <input
                            type="email"
                            id="feedbackEmail"
                            name="feedbackEmail"
                            placeholder="Digite seu e-mail (opcional)"
                        />
                    </div>
                    <div class="form-group">
                        <label for="feedbackTitle">üìù T√≠tulo:</label>
                        <input
                            type="text"
                            id="feedbackTitle"
                            name="feedbackTitle"
                            required
                            placeholder="Resumo do feedback..."
                        />
                    </div>
                    <div class="form-group">
                        <label for="feedbackDescription"
                            >üìÑ Descri√ß√£o Detalhada:</label
                        >
                        <textarea
                            id="feedbackDescription"
                            name="feedbackDescription"
                            required
                            placeholder="Descreva detalhadamente o bug, sugest√£o ou funcionalidade..."
                            rows="6"
                        ></textarea>
                    </div>
                    <div class="form-group">
                        <label for="feedbackPriority">‚ö° Prioridade:</label>
                        <select
                            id="feedbackPriority"
                            name="feedbackPriority"
                            required
                        >
                            <option value="">Selecione a prioridade...</option>
                            <option value="low">üü¢ Baixa</option>
                            <option value="medium">üü° M√©dia</option>
                            <option value="high">üî¥ Alta</option>
                            <option value="critical">üö® Cr√≠tica</option>
                        </select>
                    </div>
                    <div class="feedback-actions">
                        <button type="submit" class="btn-primary">
                            üì§ Enviar Feedback
                        </button>
                        <button
                            type="button"
                            id="btnCancelFeedback"
                            class="btn-secondary"
                        >
                            ‚ùå Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal de Pol√≠tica de Privacidade -->
        <div id="privacyModal" class="modal-overlay" style="display: none">
            <div class="modal-content privacy-modal">
                <div class="privacy-content">
                    <h2>üîí Pol√≠tica de Privacidade e Cookies</h2>

                    <div class="security-box">
                        <h3>üõ°Ô∏è Seguran√ßa e Privacidade</h3>
                        <p>
                            <strong
                                >Este sistema √© 100% seguro e privado.</strong
                            >
                            Todos os dados s√£o armazenados localmente em seu
                            dispositivo, sem qualquer transmiss√£o para
                            servidores externos.
                        </p>
                    </div>

                    <h3>üç™ Uso de Cookies e Armazenamento Local</h3>
                    <p>Este sistema utiliza:</p>
                    <ul>
                        <li>
                            <strong>localStorage:</strong> Para salvar
                            registros, configura√ß√µes e dados de sess√£o
                        </li>
                        <li>
                            <strong>Cookies de sess√£o:</strong> Para manter o
                            estado de login e prefer√™ncias
                        </li>
                        <li>
                            <strong>Armazenamento tempor√°rio:</strong> Para
                            funcionalidades do sistema
                        </li>
                    </ul>

                    <div class="highlight">
                        <h3>‚ö†Ô∏è Importante</h3>
                        <p>
                            <strong
                                >N√£o armazenamos nenhuma informa√ß√£o
                                online.</strong
                            >
                            Todos os dados ficam exclusivamente em seu
                            dispositivo. O √∫nico v√≠nculo online √© para envio de
                            feedback por email quando voc√™ solicitar.
                        </p>
                    </div>

                    <h3>üíº Uso Profissional</h3>
                    <p>Este sistema √© destinado exclusivamente para:</p>
                    <ul>
                        <li>Uso corporativo e profissional</li>
                        <li>Controle de protocolos e registros</li>
                        <li>Gest√£o de dados sens√≠veis de forma segura</li>
                        <li>Compliance com pol√≠ticas de privacidade</li>
                    </ul>

                    <h3>üìß Comunica√ß√£o Online</h3>
                    <p>O √∫nico recurso online dispon√≠vel √©:</p>
                    <ul>
                        <li>
                            <strong>Sistema de Feedback:</strong> Envio de
                            sugest√µes, bugs ou solicita√ß√µes por email
                        </li>
                        <li>
                            <strong>EmailJS:</strong> Servi√ßo de email para
                            receber feedback
                        </li>
                        <li>
                            <strong>Dados enviados:</strong> Apenas informa√ß√µes
                            do feedback (nome, email, descri√ß√£o)
                        </li>
                    </ul>

                    <h3>üîê Prote√ß√£o de Dados</h3>
                    <p>Seus dados est√£o protegidos porque:</p>
                    <ul>
                        <li>N√£o h√° servidor central armazenando informa√ß√µes</li>
                        <li>Dados ficam apenas em seu dispositivo</li>
                        <li>Sem rastreamento ou analytics</li>
                        <li>Sem compartilhamento com terceiros</li>
                    </ul>

                    <h3>üì± Responsabilidade do Usu√°rio</h3>
                    <p>Como os dados ficam em seu dispositivo:</p>
                    <ul>
                        <li>Fa√ßa backup regular dos dados exportados</li>
                        <li>Mantenha seu dispositivo seguro</li>
                        <li>Use em ambientes confi√°veis</li>
                        <li>Limpe dados quando necess√°rio</li>
                    </ul>

                    <div class="security-box">
                        <h3>‚úÖ Conformidade</h3>
                        <p>Este sistema est√° em conformidade com:</p>
                        <ul>
                            <li>LGPD (Lei Geral de Prote√ß√£o de Dados)</li>
                            <li>Pol√≠ticas de privacidade corporativas</li>
                            <li>Boas pr√°ticas de seguran√ßa</li>
                            <li>Princ√≠pios de prote√ß√£o de dados</li>
                        </ul>
                    </div>

                    <h3>üìû Contato</h3>
                    <p>Para d√∫vidas sobre privacidade ou seguran√ßa:</p>
                    <ul>
                        <li>
                            Use o sistema de feedback na p√°gina de visualiza√ß√£o
                        </li>
                        <li>Email: Atrav√©s do formul√°rio de feedback</li>
                        <li>Telefone: +55 11 99123-1629</li>
                    </ul>
                </div>
                <div class="modal-buttons" style="margin-top: 20px">
                    <button id="closePrivacyModal" class="btn-primary">
                        ‚úÖ Entendi e Aceito
                    </button>
                </div>
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
        <script>
            // ===== SISTEMA DE COOKIE CONSENT =====
            // Verificar se o usu√°rio j√° aceitou os cookies
            function checkCookieConsent() {
                const consent = localStorage.getItem("cookieConsent");
                if (!consent) {
                    // Mostrar banner de cookies
                    document.getElementById("cookieBanner").style.display =
                        "block";
                }
            }

            // Aceitar cookies
            function acceptCookies() {
                localStorage.setItem("cookieConsent", "accepted");
                localStorage.setItem(
                    "cookieConsentDate",
                    new Date().toISOString()
                );

                // Esconder banner com anima√ß√£o
                const banner = document.getElementById("cookieBanner");
                banner.classList.add("hidden");

                setTimeout(() => {
                    banner.style.display = "none";
                    banner.classList.remove("hidden");
                }, 500);
            }

            // Mostrar modal de pol√≠tica de privacidade
            function showPrivacyModal() {
                document.getElementById("privacyModal").style.display = "flex";
            }

            // Fechar modal de pol√≠tica de privacidade
            function closePrivacyModal() {
                document.getElementById("privacyModal").style.display = "none";
            }

            // Fun√ß√µes para puxar e exibir dados do localStorage
            function carregarRegistros() {
                return JSON.parse(localStorage.getItem("registrosAPN") || "[]");
            }
            function calcularEstatisticas(registros) {
                const stats = { resolvidos: 0, bko: 0, supervisao: 0 };
                registros.forEach((registro) => {
                    switch (registro.resolucao) {
                        case "Resolvido":
                            stats.resolvidos++;
                            break;
                        case "BKO":
                            stats.bko++;
                            break;
                        case "Supervis√£o":
                            stats.supervisao++;
                            break;
                    }
                });
                return stats;
            }
            function formatarData(dataISO) {
                const data = new Date(dataISO + "T00:00:00");
                return data.toLocaleDateString("pt-BR");
            }
            function exibirRegistros(registros) {
                const container = document.getElementById("recordsList");
                if (!registros.length) {
                    container.innerHTML =
                        '<div class="no-records">Nenhum registro encontrado</div>';
                    return;
                }
                container.innerHTML = registros
                    .map(
                        (registro) => `
             <div class="record-item">
                 <div class="record-header">
                     <div class="record-number">Registro N¬∫${
                         registro.numero
                     }</div>
                     <div class="resolution-badge resolution-${registro.resolucao
                         .toLowerCase()
                         .replace("√£", "a")}">
                         ${registro.resolucao}
                     </div>
                 </div>
                 <div class="record-details">
                     <div class="detail-item">
                         <div class="detail-label">Empresa/CNPJ</div>
                         <div class="detail-value">${registro.contrato}</div>
                     </div>
                     <div class="detail-item">
                         <div class="detail-label">Interlocutor</div>
                         <div class="detail-value">${
                             registro.interlocutor
                         }</div>
                     </div>
                     <div class="detail-item">
                         <div class="detail-label">Protocolo</div>
                         <div class="detail-value">${registro.protocolo}</div>
                     </div>
                     <div class="detail-item">
                         <div class="detail-label">Data da Liga√ß√£o</div>
                         <div class="detail-value">${formatarData(
                             registro.dataLigacao
                         )}</div>
                     </div>
                     <div class="detail-item" style="grid-column: 1 / -1;">
                         <div class="detail-label">Motivo</div>
                         <div class="detail-value">${registro.motivo}</div>
                     </div>
                 </div>
                 <div class="record-actions">
                     <button class="btn-action btn-edit" onclick="editarRegistro(${
                         registro.numero
                     })" title="Editar registro">
                         ‚úèÔ∏è Editar
                     </button>
                     <button class="btn-action btn-delete" onclick="excluirRegistro(${
                         registro.numero
                     })" title="Excluir registro">
                         üóëÔ∏è Excluir
                     </button>
                 </div>
             </div>
         `
                    )
                    .join("");
            }
            function criarGrafico(registros) {
                const ctx = document
                    .getElementById("statusChart")
                    .getContext("2d");
                if (!registros.length) {
                    document.querySelector(".chart-container").innerHTML =
                        '<div class="no-data-message">üìä Nenhum dado dispon√≠vel para exibir gr√°fico</div>';
                    return;
                }
                const dados = calcularEstatisticas(registros);
                new Chart(ctx, {
                    type: "doughnut",
                    data: {
                        labels: ["Resolvidos", "BKO", "Supervis√£o"],
                        datasets: [
                            {
                                data: [
                                    dados.resolvidos,
                                    dados.bko,
                                    dados.supervisao,
                                ],
                                backgroundColor: [
                                    "#48bb78",
                                    "#f56565",
                                    "#ed8936",
                                ],
                                borderColor: ["#38a169", "#e53e3e", "#dd6b20"],
                                borderWidth: 2,
                                hoverOffset: 10,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: "Status dos Protocolos",
                                font: { size: 16, weight: "bold" },
                                color: "#4a5568",
                            },
                            legend: {
                                position: "bottom",
                                labels: {
                                    padding: 20,
                                    font: { size: 12 },
                                    color: "#4a5568",
                                },
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const label = context.label || "";
                                        const value = context.parsed;
                                        const total =
                                            context.dataset.data.reduce(
                                                (a, b) => a + b,
                                                0
                                            );
                                        const percentage = (
                                            (value / total) *
                                            100
                                        ).toFixed(1);
                                        return `${label}: ${value} (${percentage}%)`;
                                    },
                                },
                            },
                        },
                    },
                });
            }
            function exportarGraficoParaCSV(registros) {
                const stats = calcularEstatisticas(registros);
                const linhas = [
                    ["Status", "Quantidade"],
                    ["Resolvido", stats.resolvidos],
                    ["BKO", stats.bko],
                    ["Supervis√£o", stats.supervisao],
                ];
                const csv = linhas.map((linha) => linha.join(",")).join("\n");
                const blob = new Blob([csv], {
                    type: "text/csv;charset=utf-8;",
                });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `estatisticas_grafico_apn_${
                    new Date().toISOString().split("T")[0]
                }.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
            function exportarParaTXT(registros) {
                if (!registros.length) {
                    alert("N√£o h√° registros para exportar!");
                    return;
                }
                let conteudo = "DI√ÅRIO DE REGISTRO APN\n";
                conteudo += "========================\n\n";
                registros.forEach((registro) => {
                    conteudo += `Registro N¬∫${registro.numero}\n`;
                    conteudo += `Empresa/CNPJ: ${registro.contrato}\n`;
                    conteudo += `Interlocutor: ${registro.interlocutor}\n`;
                    conteudo += `Protocolo: ${registro.protocolo}\n`;
                    conteudo += `Motivo: ${registro.motivo}\n`;
                    conteudo += `Data: ${formatarData(registro.dataLigacao)}\n`;
                    conteudo += `Resolu√ß√£o: ${registro.resolucao}\n\n`;
                    conteudo += "---\n\n";
                });
                const blob = new Blob([conteudo], {
                    type: "text/plain;charset=utf-8",
                });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `registros_apn_${
                    new Date().toISOString().split("T")[0]
                }.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            }

            function exportarParaCSV(registros) {
                if (!registros.length) {
                    alert("N√£o h√° registros para exportar!");
                    return;
                }

                // Cabe√ßalho do CSV
                const headers = [
                    "N√∫mero",
                    "Empresa/CNPJ",
                    "Interlocutor",
                    "Protocolo",
                    "Data da Liga√ß√£o",
                    "Motivo",
                    "Resolu√ß√£o",
                    "Timestamp",
                ];

                // Dados dos registros
                const csvData = registros.map((registro) => [
                    registro.numero,
                    `"${registro.contrato}"`,
                    `"${registro.interlocutor}"`,
                    `"${registro.protocolo}"`,
                    formatarData(registro.dataLigacao),
                    `"${registro.motivo.replace(/"/g, '""')}"`, // Escapar aspas duplas
                    registro.resolucao,
                    registro.timestamp,
                ]);

                // Combinar cabe√ßalho e dados
                const csvContent = [headers, ...csvData]
                    .map((row) => row.join(","))
                    .join("\n");

                // Adicionar BOM para UTF-8
                const BOM = "\uFEFF";
                const blob = new Blob([BOM + csvContent], {
                    type: "text/csv;charset=utf-8",
                });

                const url = window.URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `registros_apn_${
                    new Date().toISOString().split("T")[0]
                }.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            }

            function exportarParaJSON(registros) {
                if (!registros.length) {
                    alert("N√£o h√° registros para exportar!");
                    return;
                }

                // Criar objeto com metadados e dados
                const exportData = {
                    metadata: {
                        exportDate: new Date().toISOString(),
                        totalRecords: registros.length,
                        version: "1.0",
                        description:
                            "Exporta√ß√£o de registros APN para importa√ß√£o",
                    },
                    registros: registros,
                };

                const jsonContent = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonContent], {
                    type: "application/json;charset=utf-8",
                });

                const url = window.URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `registros_apn_${
                    new Date().toISOString().split("T")[0]
                }.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            }
            // Vari√°veis globais para CRUD
            let registros = [];
            let registroEditando = null;

            // Fun√ß√µes CRUD
            function editarRegistro(numero) {
                const registro = registros.find((r) => r.numero === numero);
                if (!registro) return;

                registroEditando = registro;

                // Preencher formul√°rio com dados do registro
                document.getElementById("editContrato").value =
                    registro.contrato;
                document.getElementById("editInterlocutor").value =
                    registro.interlocutor;
                document.getElementById("editProtocolo").value =
                    registro.protocolo;
                document.getElementById("editDataLigacao").value =
                    registro.dataLigacao;
                document.getElementById("editMotivo").value = registro.motivo;

                // Marcar radio button correto
                document
                    .querySelectorAll('input[name="resolucao"]')
                    .forEach((radio) => {
                        radio.checked = radio.value === registro.resolucao;
                    });

                // Mostrar modal
                document.getElementById("modalEditar").style.display = "flex";
            }

            function excluirRegistro(numero) {
                if (
                    confirm(
                        `Tem certeza que deseja excluir o Registro N¬∫${numero}? Esta a√ß√£o n√£o pode ser desfeita.`
                    )
                ) {
                    registros = registros.filter((r) => r.numero !== numero);
                    localStorage.setItem(
                        "registrosAPN",
                        JSON.stringify(registros)
                    );

                    // Atualizar interface
                    exibirRegistros(registros);
                    criarGrafico(registros);

                    // Mostrar mensagem de sucesso
                    mostrarMensagem(
                        "Registro exclu√≠do com sucesso!",
                        "success"
                    );
                }
            }

            function salvarEdicao(event) {
                event.preventDefault();

                if (!registroEditando) return;

                const formData = new FormData(event.target);

                // Atualizar dados do registro
                registroEditando.contrato = formData.get("contrato");
                registroEditando.interlocutor = formData.get("interlocutor");
                registroEditando.protocolo = formData.get("protocolo");
                registroEditando.dataLigacao = formData.get("dataLigacao");
                registroEditando.motivo = formData.get("motivo");
                registroEditando.resolucao = formData.get("resolucao");
                registroEditando.timestamp = new Date().toISOString();

                // Salvar no localStorage
                localStorage.setItem("registrosAPN", JSON.stringify(registros));

                // Fechar modal
                fecharModalEdicao();

                // Atualizar interface
                exibirRegistros(registros);
                criarGrafico(registros);

                // Mostrar mensagem de sucesso
                mostrarMensagem("Registro atualizado com sucesso!", "success");
            }

            function fecharModalEdicao() {
                document.getElementById("modalEditar").style.display = "none";
                document.getElementById("formEditar").reset();
                registroEditando = null;
            }

            function mostrarMensagem(texto, tipo) {
                const mensagem = document.createElement("div");
                mensagem.className = `mensagem ${tipo}`;
                mensagem.textContent = texto;

                document.body.appendChild(mensagem);

                setTimeout(() => {
                    mensagem.remove();
                }, 3000);
            }

            document.addEventListener("DOMContentLoaded", function () {
                checkCookieConsent(); // Chamar a fun√ß√£o para verificar o consentimento
                registros = carregarRegistros();
                exibirRegistros(registros);
                criarGrafico(registros);

                // Event listeners para cookies
                document
                    .getElementById("acceptCookies")
                    .addEventListener("click", acceptCookies);
                document
                    .getElementById("learnMore")
                    .addEventListener("click", showPrivacyModal);
                document
                    .getElementById("closePrivacyModal")
                    .addEventListener("click", closePrivacyModal);

                // Fechar modal ao clicar fora
                document
                    .getElementById("privacyModal")
                    .addEventListener("click", function (e) {
                        if (e.target === this) {
                            closePrivacyModal();
                        }
                    });

                // Event listeners
                document
                    .getElementById("exportChartBtn")
                    .addEventListener("click", function () {
                        exportarGraficoParaCSV(registros);
                    });

                document
                    .getElementById("exportBtn")
                    .addEventListener("click", function () {
                        exportarParaTXT(registros);
                    });

                document
                    .getElementById("exportCsvBtn")
                    .addEventListener("click", function () {
                        exportarParaCSV(registros);
                    });

                document
                    .getElementById("exportJsonBtn")
                    .addEventListener("click", function () {
                        exportarParaJSON(registros);
                    });

                document
                    .getElementById("btnVoltar")
                    .addEventListener("click", function () {
                        window.location.href = "index.html";
                    });

                document
                    .getElementById("btnImportar")
                    .addEventListener("click", function () {
                        window.location.href = "importar.html";
                    });

                document
                    .getElementById("clearBtn")
                    .addEventListener("click", function () {
                        if (
                            confirm(
                                "Tem certeza que deseja limpar todos os registros? Esta a√ß√£o n√£o pode ser desfeita."
                            )
                        ) {
                            localStorage.removeItem("registrosAPN");
                            alert(
                                "Todos os registros foram removidos com sucesso!"
                            );
                            window.location.reload();
                        }
                    });

                // Event listeners para modal de edi√ß√£o
                document
                    .getElementById("formEditar")
                    .addEventListener("submit", salvarEdicao);

                document
                    .getElementById("btnCancelarEdicao")
                    .addEventListener("click", fecharModalEdicao);

                // Fechar modal ao clicar fora
                document
                    .getElementById("modalEditar")
                    .addEventListener("click", function (e) {
                        if (e.target === this) {
                            fecharModalEdicao();
                        }
                    });

                // ===== SISTEMA DE FEEDBACK =====
                // Configura√ß√£o do EmailJS
                const EMAILJS_CONFIG = {
                    serviceId: "service_gzeyzlb", // ‚úÖ Seu Service ID do EmailJS
                    templateId: "template_snr3m3s", // ‚úÖ Seu Template ID
                    userId: "iIrbsM4l7b0J9D0Wh", // ‚úÖ Seu User ID do EmailJS
                };

                // Event listeners para o sistema de feedback
                const btnFeedback = document.getElementById("btnFeedback");
                if (btnFeedback) {
                    btnFeedback.addEventListener("click", function () {
                        document.getElementById("feedbackModal").style.display =
                            "flex";
                    });
                }

                const btnCancelFeedback =
                    document.getElementById("btnCancelFeedback");
                if (btnCancelFeedback) {
                    btnCancelFeedback.addEventListener("click", function () {
                        fecharModalFeedback();
                    });
                }

                const feedbackForm = document.getElementById("feedbackForm");
                if (feedbackForm) {
                    feedbackForm.addEventListener("submit", function (e) {
                        e.preventDefault();
                        enviarFeedback();
                    });
                }

                const feedbackModal = document.getElementById("feedbackModal");
                if (feedbackModal) {
                    feedbackModal.addEventListener("click", function (e) {
                        if (e.target === this) {
                            fecharModalFeedback();
                        }
                    });
                }

                // Fun√ß√£o para fechar modal de feedback
                function fecharModalFeedback() {
                    const modal = document.getElementById("feedbackModal");
                    const form = document.getElementById("feedbackForm");
                    if (modal) modal.style.display = "none";
                    if (form) form.reset();
                }

                // Fun√ß√£o para enviar feedback
                async function enviarFeedback() {
                    const formData = new FormData(
                        document.getElementById("feedbackForm")
                    );
                    const feedback = {
                        type: formData.get("feedbackType"),
                        name: formData.get("feedbackName") || "An√¥nimo",
                        email: formData.get("feedbackEmail") || "N√£o informado",
                        title: formData.get("feedbackTitle"),
                        description: formData.get("feedbackDescription"),
                        priority: formData.get("feedbackPriority"),
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        url: window.location.href,
                    };

                    // Salvar feedback no localStorage (backup)
                    salvarFeedback(feedback);

                    try {
                        // Enviar email via EmailJS
                        await enviarEmailEmailJS(feedback);

                        // Mostrar mensagem de sucesso
                        mostrarMensagemFeedback(
                            "‚úÖ Feedback enviado com sucesso! Obrigado por contribuir.",
                            "success"
                        );
                    } catch (error) {
                        console.error("Erro ao enviar email:", error);
                        // Mostrar mensagem de erro, mas informar que foi salvo localmente
                        mostrarMensagemFeedback(
                            "‚ö†Ô∏è Email n√£o enviado, mas feedback salvo localmente. Tente novamente mais tarde.",
                            "error"
                        );
                    }

                    // Fechar modal
                    fecharModalFeedback();
                }

                // Fun√ß√£o para enviar email via EmailJS
                async function enviarEmailEmailJS(feedback) {
                    // Inicializar EmailJS
                    emailjs.init(EMAILJS_CONFIG.userId);

                    const templateParams = {
                        user_name: feedback.name || "An√¥nimo",
                        user_email: feedback.email || "N√£o informado",
                        feedback_type: getTipoFeedback(feedback.type),
                        feedback_title: feedback.title,
                        feedback_priority: getPrioridadeFeedback(
                            feedback.priority
                        ),
                        feedback_description: feedback.description,
                        feedback_timestamp: new Date(
                            feedback.timestamp
                        ).toLocaleString("pt-BR"),
                        user_agent: feedback.userAgent,
                        feedback_url: feedback.url,
                    };

                    try {
                        const response = await emailjs.send(
                            EMAILJS_CONFIG.serviceId,
                            EMAILJS_CONFIG.templateId,
                            templateParams
                        );

                        console.log("Email enviado com sucesso:", response);
                        return response;
                    } catch (error) {
                        console.error("Erro EmailJS:", error);
                        throw error;
                    }
                }

                // Fun√ß√£o alternativa: Abrir cliente de email padr√£o
                function abrirEmailCliente(feedback) {
                    const subject = encodeURIComponent(
                        `[APN Feedback] ${feedback.title} - ${getTipoFeedback(
                            feedback.type
                        )}`
                    );
                    const body = encodeURIComponent(
                        `
üìù NOVO FEEDBACK - SISTEMA APN

üë§ Nome: ${feedback.name}
üìß Email: ${feedback.email}
üìã Tipo: ${getTipoFeedback(feedback.type)}
üìù T√≠tulo: ${feedback.title}
‚ö° Prioridade: ${getPrioridadeFeedback(feedback.priority)}
üìÖ Data: ${new Date(feedback.timestamp).toLocaleString("pt-BR")}

üìÑ DESCRI√á√ÉO:
${feedback.description}

üîç INFORMA√á√ïES T√âCNICAS:
üåê Navegador: ${feedback.userAgent}
üì± P√°gina: ${feedback.url}

---
Este email foi enviado automaticamente pelo sistema de feedback APN.
                    `.trim()
                    );

                    const emailTo = "seu-email@exemplo.com"; // ‚ö†Ô∏è Substitua pelo seu email
                    const mailtoLink = `mailto:${emailTo}?subject=${subject}&body=${body}`;

                    window.open(mailtoLink, "_blank");
                }

                // Fun√ß√£o para salvar feedback no localStorage
                function salvarFeedback(feedback) {
                    const feedbacks = JSON.parse(
                        localStorage.getItem("feedbacksAPN") || "[]"
                    );
                    feedbacks.push(feedback);
                    localStorage.setItem(
                        "feedbacksAPN",
                        JSON.stringify(feedbacks)
                    );
                }

                // Fun√ß√£o para mostrar mensagem de feedback
                function mostrarMensagemFeedback(texto, tipo) {
                    const mensagem = document.createElement("div");
                    mensagem.className = `mensagem ${tipo}`;
                    mensagem.textContent = texto;
                    document.body.appendChild(mensagem);
                    setTimeout(() => {
                        mensagem.remove();
                    }, 5000);
                }

                // Fun√ß√µes auxiliares para tradu√ß√£o
                function getTipoFeedback(type) {
                    const tipos = {
                        bug: "üêõ Reportar Bug",
                        suggestion: "üí° Sugest√£o de Melhoria",
                        feature: "‚ú® Solicitar Nova Funcionalidade",
                        other: "üìù Outro",
                    };
                    return tipos[type] || type;
                }

                function getPrioridadeFeedback(priority) {
                    const prioridades = {
                        low: "üü¢ Baixa",
                        medium: "üü° M√©dia",
                        high: "üî¥ Alta",
                        critical: "üö® Cr√≠tica",
                    };
                    return prioridades[priority] || priority;
                }
            });
        </script>
    </body>
</html>
